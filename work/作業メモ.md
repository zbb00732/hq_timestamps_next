# 作業メモ

## タイムスタンプ記録に必要な情報
タイムスタンプ記録に必要な情報は、下記である
1. 選択したキャラクター
2. 試合開始時間
3. 試合決着時の獲得フラッグ数

## 1.選択したキャラクターの取得
キャラクター選択画面では、プレイヤーがキャラクターを決定したかどうかを画面から読み取ることができない。
そのため、キャラクター選択画面から次の画面に切り替わる直前のタイミング（フレーム番号）を記憶しておき、
後で（試合開始時）そのフレームの画面に遡り、表示されているキャラクターを取得する。

また、キャラクター選択画面が表示されたら、以下の操作を行う
・試合進行状況ステータスを「キャラクター選択画面」にする



## 2.試合開始時間の取得
試合進行状況ステータス（≒直前の状況）が
　A.「キャラクター選択画面」　または
　B.「試合終了後」
の状態から、最初に対戦画面・試合開始後（※１）が表示されたタイミングで試合開始と判定する。

　（※１）対戦画面・試合開始後
　　画面上部左右にフラッグが表示され、両者ともフラッグを獲得していない（＝全部白）の状態。

Aから遷移した場合は新規の試合
Bから遷移した場合はリマッチである

なおYoutubeのタイムスタンプとして記録する時間は、試合初期画面表示の3秒前とする。

また最初に対戦画面・試合開始後が表示されたタイミング（試合開始直後）で、以下のことを行う
・選択したキャラクターを取得する（1で記載した通り）
・最大フラッグ数を取得する
・試合進行状況ステータスを変更する
　　最大フラッグ数が2以上の場合はステータスを「対戦画面・試合開始後」にする
　　最大フラッグ数が1の場合はステータスを「残り１フラッグ（※１）」にする

（※１）残り１フラッグ
　タイムスタンプの情報取得自体には不要だが、処理高速化のためにこのステータスを設ける。詳細は後述。


## 3. 試合決着時の獲得フラッグ数
（直前の）試合進行状況ステータスが「残り１フラッグ」かつ
左右どちらかの獲得フラッグ（赤）が最大数に達したタイミングで試合決着と判定する。
ここで１試合分のタイムスタンプに必要な情報が揃うので、これを記録する。

またこのとき、以下のことを行う
・試合進行状況ステータスを「試合終了後」にする


## 試合有効/無効の判定
左右どちらかの獲得フラッグが最大数に達したことをもって試合有効（かつ決着）とする
両者のフラッグがどちらも最大数に達していない状態（試合途中）でトップメニューに戻った場合は
無効試合としてタイムスタンプには記録しない。


## 処理の高速化
基本的には上記のロジックでタイムスタンプを記録できる。
しかし、動画を1フレームずつ全て読み出して処理を行うと時間がかかってしまう。
そこで、タイムスタンプ記録に必要な情報を得られるタイミング以外はなるべくフレームを読み飛ばすようにすることで、処理の高速化を図る。
具体的には、以下のようにする。

1. キャラクター選択画面
　キャラクター選択画面から次の画面に切り替わる直前のタイミングを取得する必要があるため、
　0.25秒刻みでフレームをチェックする。

2. 試合中（試合開始～残り１フラッグになるまで）
　この時間帯は、タイムスタンプに必要な情報を得られないため
　3秒おきに飛ばしていく。

3. 残り１フラッグ
　試合決着のタイミングを取りこぼさないよう、
　0.5秒刻みでチェックする。

4. 試合終了後
　次のキャラクター選択画面やリマッチ試合開始までは特に必要な情報を得られないため
　2秒おきに飛ばしていく。

5. 暗転画面
　試合開始の直前に暗転するため、開始のタイミングを取りこぼさないよう
　1秒おきにチェックする。
　なお試合開始時間は多少ズレても問題ないため、あまり細かく刻む必要はない。

6. その他の画面
　各種メニューやロード画面、ポーズ画面など。
　これらの画面からすぐにタイムスタンプ記録に必要な画面に遷移することはないため
　2秒おきに飛ばしていく。

以上
